name: Publish Unlocked Package

on:
    workflow_call:

jobs:
    publish-unlocked-package:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
            - uses: actions/create-github-app-token@v1
              id: app-token
              with:
                app-id: ${{ secrets.APP_ID }}
                private-key: ${{ secrets.APP_SECRET }}
            - name: Create Auth File
              run: scripts/bash/create-sfdx-auth-file.sh
            - name: Authenticate DevHub
              run: scripts/bash/config-sf.sh
            - name: Publish Package
              run: |
                npm run sf:moxygen:version:create
                git config --global user.name 'GitHub Action Bot'
                git config --global user.email 'action@github.com'
                git checkout -b moxygen-${{ github.run_id }}
                git add sfdx-project.json
                git commit -m "[Automated] Created Package Version"
                git push --set-upstream origin moxygen-${{ github.run_id }}
                echo ${{ steps.app-token.outputs.token }} | gh auth login --with-token
                gh pr create --title "Publish Moxygen" --body "Automated PR to publish Moxygen" --base main
                echo ${{ github.token }} | gh auth login --with-token
                gh pr review moxygen-${{ github.run_id }} -a
                echo ${{ steps.app-token.outputs.token }} | gh auth login --with-token
                gh pr merge --squash --admin